services:
  grafana:
    image: grafana/grafana:12.1.0@sha256:6ac590e7cabc2fbe8d7b8fc1ce9c9f0582177b334e0df9c927ebd9670469440f
    container_name: grafana
    restart: unless-stopped
    labels:
      - traefik.http.routers.grafana.rule=Host(`grafana.spaceduck.cloud`)
      - traefik.http.services.grafana.loadbalancer.server.port=3000
      - traefik.http.routers.grafana.tls=true
      - traefik.http.routers.grafana.tls.certresolver=letsencryptprod
    volumes:
      - grafana_data:/data
    networks:
      - grafana
      - traefik
      - auth
    environment:
      LDAP_BIND_PASSWORD: ${LDAP_BIND_PASSWORD}
    configs:
      - source: grafana_ini
        target: /etc/grafana/grafana.ini
      - source: grafana_ldap
        target: /etc/grafana/ldap.toml
networks:
  traefik:
    name: traefik_default
    external: true
  auth:
    name: auth_auth
    external: true
  grafana:
volumes:
  grafana_data:
    driver: local
configs:
  grafana_ini:
    content: |
      [auth.ldap]
      enabled = true
      config_file = /etc/grafana/ldap.toml
      allow_sign_up = true
  grafana_ldap:
    content: |
      [[servers]]
      host = "ldap"
      port = 3890
      timeout = 10

      bind_dn = "uid=grafana_bind,ou=people,dc=spaceduck,dc=cloud"
      bind_password = '$$__env{LDAP_BIND_PASSWORD}'


      search_filter = "(uid=%s)"
      search_base_dns = ["dc=spaceduck,dc=cloud"]
      # group_search_filter = "(&(objectClass=posixGroup)(memberUid=%s))"
      # group_search_filter_user_attribute = "distinguishedName"
      # group_search_base_dns = ["ou=groups,dc=grafana,dc=org"]

      [servers.attributes]
      member_of = "memberOf"
      email = "mail"
      name = "displayName"
      surname = "sn"
      username = "uid"

